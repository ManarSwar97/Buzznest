<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... existing head content ... -->
    <style>
        /* Add to your existing styles */
        .follow-btn {
            transition: all 0.2s;
        }
        .follow-btn:hover {
            transform: scale(1.05);
        }
        .followers-count {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <%- include('../navbar/_navbar.ejs')%>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>All Groups</h1>
            <a href="/group/new" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Create New Group
            </a>
        </div>

        <% if (group && group.length > 0) { %>
            <div class="group-grid">
                <% group.forEach(g => { %>
                    <div class="group-card">
                        <div class="group-img-container">
                            <img src="/uploads/<%= g.groupImage || 'group-default.jpg' %>" 
                                 alt="<%= g.groupName %>" 
                                 class="group-img">
                        </div>
                        <div class="group-body">
                            <h3 class="group-title"><%= g.groupName %></h3>
                            
                            <% if (g.game) { %>
                                <p class="game-info">
                                    <i class="bi bi-controller"></i> <%= g.game %>
                                </p>
                            <% } %>
                            
                            <% if (g.user) { %>
                                <p class="creator-info">
                                    Created by: <%= g.user.username %>
                                </p>
                            <% } %>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <span class="followers-count">
                                        <i class="bi bi-people-fill"></i> 
                                        <span class="follower-count-<%= g._id %>">
                                            <%= g.followerCount || 0 %>
                                        </span> followers
                                    </span>
                                </div>
                                <a href="/group/<%= g._id %>" class="text-primary">View Group â†’</a>
                            </div>

                            <% if (req.session.user) { %>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary w-100 follow-btn" 
                                            data-group-id="<%= g._id %>"
                                            id="follow-btn-<%= g._id %>">
                                        <span class="follow-text">Follow</span>
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="no-group-message">
                <h3>No groups found</h3>
                <p>Be the first to create a gaming group!</p>
                <a href="/group/new" class="btn btn-primary">
                    Create Your First Group
                </a>
            </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update follow button appearance
        function updateFollowButton(groupId, isFollowing, followerCount) {
            const btn = document.getElementById(`follow-btn-${groupId}`);
            const countSpan = document.querySelector(`.follower-count-${groupId}`);
            
            if (btn) {
                btn.classList.toggle('btn-outline-primary', !isFollowing);
                btn.classList.toggle('btn-primary', isFollowing);
                btn.querySelector('.follow-text').textContent = isFollowing ? 'Following' : 'Follow';
            }
            
            if (countSpan) {
                countSpan.textContent = followerCount;
            }
        }

        // Initialize follow buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Check follow status for each group when page loads
            document.querySelectorAll('.follow-btn').forEach(btn => {
                const groupId = btn.dataset.groupId;
                
                fetch(`/group/${groupId}/follow-status`)
                    .then(res => res.json())
                    .then(data => {
                        updateFollowButton(groupId, data.isFollowing, data.followerCount);
                    });
                
                // Add click handler
                btn.addEventListener('click', () => {
                    fetch(`/group/${groupId}/follow`, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            updateFollowButton(groupId, data.isFollowing, data.followerCount);
                        }
                    })
                    .catch(err => console.error('Error:', err));
                });
            });
        });
    </script>
</body>
</html>